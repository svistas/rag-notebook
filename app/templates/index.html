{% extends "base.html" %}
{% block content %}
<div class="space-y-6">
  <header class="bg-white rounded-xl border border-slate-200 p-5">
    <h1 class="text-2xl font-semibold">RAG Notebook</h1>
    <p class="text-slate-600 mt-2">Upload a .txt or .md file and ask grounded questions with citations.</p>
  </header>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <section class="bg-white rounded-xl border border-slate-200 p-5 space-y-4">
      <h2 class="text-lg font-medium">Upload Document</h2>
      <form id="upload-form" class="space-y-3">
        <input id="file-input" type="file" accept=".txt,.md" class="block w-full text-sm" />
        <button class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700" type="submit">Upload</button>
      </form>
      <p id="upload-status" class="text-sm text-slate-600"></p>
      <div>
        <h3 class="font-medium mb-2">Document Library</h3>
        <ul id="documents-list" class="text-sm space-y-2"></ul>
      </div>
    </section>

    <section class="lg:col-span-2 bg-white rounded-xl border border-slate-200 p-5 space-y-4">
      <h2 class="text-lg font-medium">Chat</h2>
      <div id="chat-log" class="h-[480px] overflow-y-auto bg-slate-50 border border-slate-200 rounded p-3 space-y-3"></div>
      <div class="flex items-center justify-between">
        <label class="flex items-center gap-2 text-sm text-slate-700">
          <input id="debug-toggle" type="checkbox" class="rounded border-slate-300" />
          Debug mode
        </label>
        <p class="text-xs text-slate-500">Shows rewritten query and retrieved chunks.</p>
      </div>
      <form id="chat-form" class="flex gap-2">
        <input id="chat-input" type="text" placeholder="Ask a question about your documents..."
               class="flex-1 border border-slate-300 rounded px-3 py-2" />
        <button class="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700" type="submit">Ask</button>
      </form>
    </section>
  </div>
</div>

<script>
  const uploadForm = document.getElementById("upload-form");
  const fileInput = document.getElementById("file-input");
  const uploadStatus = document.getElementById("upload-status");
  const documentsList = document.getElementById("documents-list");
  const chatForm = document.getElementById("chat-form");
  const chatInput = document.getElementById("chat-input");
  const debugToggle = document.getElementById("debug-toggle");
  const chatLog = document.getElementById("chat-log");
  let documentsPollHandle = null;
  let lastUploadedDocId = null;

  function renderChunkList(chunks) {
    const list = document.createElement("ol");
    list.className = "list-decimal ml-5 space-y-1";
    chunks.forEach((c) => {
      const li = document.createElement("li");
      li.className = "text-xs text-slate-700";
      const preview = (c.text || "").slice(0, 160).replaceAll("\n", " ");
      const chunkId = c.id ? String(c.id).slice(-8) : "unknown";
      const docId = c.doc_id ? String(c.doc_id).slice(-8) : "unknown";
      li.textContent = `${c.document_name}#${c.chunk_index} doc=${docId} chunk=${chunkId} score=${(c.score ?? 0).toFixed(3)}: ${preview}...`;
      list.appendChild(li);
    });
    return list;
  }

  function appendMessage(role, text, citations = [], debug = null) {
    const wrapper = document.createElement("div");
    const roleClass = role === "user" ? "bg-blue-50 border-blue-200" : "bg-emerald-50 border-emerald-200";
    wrapper.className = `border ${roleClass} rounded p-3`;

    const title = document.createElement("p");
    title.className = "font-medium text-sm mb-1";
    title.textContent = role === "user" ? "You" : "Assistant";
    wrapper.appendChild(title);

    const content = document.createElement("p");
    content.className = "text-sm whitespace-pre-wrap";
    content.textContent = text;
    wrapper.appendChild(content);

    if (citations.length > 0) {
      const citationWrap = document.createElement("div");
      citationWrap.className = "mt-2 text-xs text-slate-700 space-y-1";
      citations.forEach((c) => {
        const details = document.createElement("details");
        details.className = "bg-white rounded border border-slate-200 p-2";
        const summary = document.createElement("summary");
        summary.textContent = `[${c.number}] ${c.document_name} (chunk ${c.chunk_index})`;
        details.appendChild(summary);
        const excerpt = document.createElement("p");
        excerpt.className = "mt-1 whitespace-pre-wrap";
        excerpt.textContent = c.text;
        details.appendChild(excerpt);
        citationWrap.appendChild(details);
      });
      wrapper.appendChild(citationWrap);
    }

    if (role === "assistant" && debug) {
      const dbg = document.createElement("details");
      dbg.className = "mt-3 bg-white rounded border border-slate-200 p-2";
      const sum = document.createElement("summary");
      sum.className = "text-xs font-medium text-slate-700 cursor-pointer";
      sum.textContent = "Debug: retrieval trace";
      dbg.appendChild(sum);

      const meta = document.createElement("div");
      meta.className = "mt-2 text-xs text-slate-700 space-y-2";

      const q = document.createElement("div");
      q.className = "space-y-1";
      const q1 = document.createElement("div");
      q1.textContent = `user_query: ${debug.user_query}`;
      const q2 = document.createElement("div");
      q2.textContent = `rewritten_query: ${debug.rewritten_query}`;
      q.appendChild(q1);
      q.appendChild(q2);
      meta.appendChild(q);

      const initial = document.createElement("div");
      initial.className = "space-y-1";
      const initialTitle = document.createElement("div");
      initialTitle.className = "font-medium";
      initialTitle.textContent = `initial_chunks (${debug.initial_chunks?.length || 0})`;
      initial.appendChild(initialTitle);
      if (debug.initial_chunks && debug.initial_chunks.length) {
        initial.appendChild(renderChunkList(debug.initial_chunks));
      }
      meta.appendChild(initial);

      const final = document.createElement("div");
      final.className = "space-y-1";
      const finalTitle = document.createElement("div");
      finalTitle.className = "font-medium";
      finalTitle.textContent = `final_chunks (${debug.final_chunks?.length || 0})`;
      final.appendChild(finalTitle);
      if (debug.final_chunks && debug.final_chunks.length) {
        final.appendChild(renderChunkList(debug.final_chunks));
      }
      meta.appendChild(final);

      dbg.appendChild(meta);
      wrapper.appendChild(dbg);
    }

    chatLog.appendChild(wrapper);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  function statusBadge(status) {
    const base = "inline-flex items-center px-2 py-0.5 rounded text-xs border";
    if (status === "indexed") return `${base} bg-emerald-50 text-emerald-700 border-emerald-200`;
    if (status === "indexing") return `${base} bg-blue-50 text-blue-700 border-blue-200`;
    if (status === "queued") return `${base} bg-amber-50 text-amber-700 border-amber-200`;
    return `${base} bg-rose-50 text-rose-700 border-rose-200`;
  }

  async function deleteDoc(docId) {
    const ok = confirm("Delete this document? This removes stored file and vectors.");
    if (!ok) return;
    const resp = await fetch(`/api/documents/${docId}`, { method: "DELETE" });
    const payload = await resp.json().catch(() => ({}));
    if (!resp.ok) {
      uploadStatus.textContent = payload.detail || "Delete failed.";
      return;
    }
    if (lastUploadedDocId === docId) {
      lastUploadedDocId = null;
      uploadStatus.textContent = "Document deleted.";
    }
    await refreshDocuments();
  }

  async function reindexDoc(docId) {
    const resp = await fetch(`/api/documents/${docId}/reindex`, { method: "POST" });
    const payload = await resp.json();
    if (!resp.ok) {
      uploadStatus.textContent = payload.detail || "Reindex failed.";
      return;
    }
    lastUploadedDocId = docId;
    uploadStatus.textContent = `Reindex queued for ${payload.filename} (status: ${payload.status}).`;
    await refreshDocuments(true);
  }

  function updateUploadStatusFromDoc(doc) {
    if (!doc) return;
    if (doc.status === "queued" || doc.status === "indexing") {
      uploadStatus.textContent = `Indexing ${doc.filename}... (status: ${doc.status})`;
      return;
    }
    if (doc.status === "indexed") {
      uploadStatus.textContent = `Indexed ${doc.filename} (${doc.chunk_count} chunks).`;
      return;
    }
    if (doc.status === "failed") {
      const msg = doc.error_message ? `: ${doc.error_message}` : ".";
      uploadStatus.textContent = `Indexing failed for ${doc.filename}${msg}`;
    }
  }

  async function refreshDocuments(forcePoll = false) {
    const response = await fetch("/api/documents");
    const payload = await response.json();
    documentsList.innerHTML = "";

    if (!payload.documents || payload.documents.length === 0) {
      const item = document.createElement("li");
      item.className = "text-slate-500";
      item.textContent = "No documents indexed yet.";
      documentsList.appendChild(item);
      return;
    }

    let shouldPoll = false;
    let lastDoc = null;
    payload.documents.forEach((doc) => {
      if (lastUploadedDocId && doc.id === lastUploadedDocId) {
        lastDoc = doc;
      }
      const item = document.createElement("li");
      item.className = "border border-slate-200 rounded p-2 space-y-2";

      const top = document.createElement("div");
      // min-w-0 is important to keep action buttons from spilling out of the left panel.
      top.className = "flex items-start justify-between gap-2 min-w-0";

      const left = document.createElement("div");
      left.className = "min-w-0";
      const name = document.createElement("div");
      name.className = "font-medium truncate";
      name.textContent = doc.filename;
      left.appendChild(name);

      const meta = document.createElement("div");
      meta.className = "text-xs text-slate-600";
      meta.textContent = `${doc.chunk_count} chunks`;
      left.appendChild(meta);

      if (doc.error_message) {
        const err = document.createElement("div");
        err.className = "text-xs text-rose-700 mt-1";
        err.textContent = doc.error_message;
        left.appendChild(err);
      }

      const right = document.createElement("div");
      right.className = "flex items-center gap-2 shrink-0";
      const badge = document.createElement("span");
      badge.className = statusBadge(doc.status);
      badge.textContent = doc.status;
      right.appendChild(badge);

      const delBtn = document.createElement("button");
      delBtn.className = "px-2 py-1 text-xs rounded border border-slate-300 hover:bg-slate-50";
      delBtn.textContent = "Delete";
      delBtn.onclick = () => deleteDoc(doc.id);
      right.appendChild(delBtn);

      const reBtn = document.createElement("button");
      reBtn.className = "px-2 py-1 text-xs rounded border border-slate-300 hover:bg-slate-50";
      reBtn.textContent = "Reindex";
      reBtn.onclick = () => reindexDoc(doc.id);
      right.appendChild(reBtn);

      top.appendChild(left);
      top.appendChild(right);
      item.appendChild(top);
      documentsList.appendChild(item);

      if (doc.status === "queued" || doc.status === "indexing") {
        shouldPoll = true;
      }
    });

    if (lastDoc) {
      updateUploadStatusFromDoc(lastDoc);
    }

    if ((shouldPoll || forcePoll) && !documentsPollHandle) {
      documentsPollHandle = setInterval(() => refreshDocuments(), 2000);
    }
    if (!shouldPoll && documentsPollHandle) {
      clearInterval(documentsPollHandle);
      documentsPollHandle = null;
    }
  }

  uploadForm.addEventListener("submit", async (event) => {
    event.preventDefault();
    if (!fileInput.files || fileInput.files.length === 0) {
      uploadStatus.textContent = "Choose a file first.";
      return;
    }

    const formData = new FormData();
    formData.append("file", fileInput.files[0]);
    uploadStatus.textContent = "Uploading (indexing will run in background)...";

    const response = await fetch("/api/upload", { method: "POST", body: formData });
    const payload = await response.json();

    if (!response.ok) {
      uploadStatus.textContent = payload.detail || "Upload failed.";
      return;
    }

    lastUploadedDocId = payload.document.id;
    uploadStatus.textContent = `Upload accepted: ${payload.document.filename} (status: ${payload.document.status}).`;
    fileInput.value = "";
    await refreshDocuments(true);
  });

  chatForm.addEventListener("submit", async (event) => {
    event.preventDefault();
    const query = chatInput.value.trim();
    if (!query) {
      return;
    }

    appendMessage("user", query);
    chatInput.value = "";

    const response = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ query, debug: debugToggle.checked }),
    });
    const payload = await response.json();
    if (!response.ok) {
      appendMessage("assistant", payload.detail || "Chat failed.");
      return;
    }

    appendMessage("assistant", payload.answer, payload.citations || [], payload.debug || null);
  });

  refreshDocuments();
</script>
{% endblock %}
